rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // 定義一個變數來存儲允許寫入的 Admin UID
    function isAllowedAdmin() {
      return request.auth != null && request.auth.uid == 'pOxClMAbnoOm3DLApNLrKNAr5892';
    }

    // Default: everyone can read, but generic writes are denied.
    match /{document=**} {
      allow read: if true;
      allow write: if false;
    }

    // artworks: 保持您原有的邏輯
    match /artworks/{artworkId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null
        || (
          request.auth == null
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['artwork_liked', 'artwork_viewed'])
          && (
            (!('artwork_liked' in request.resource.data) || request.resource.data.artwork_liked is int)
            && (!('artwork_viewed' in request.resource.data) || request.resource.data.artwork_viewed is int)
          )
        );
      allow delete: if false;
    }

    // exhibitions: 修改這裡，比照 artworks 的邏輯
    match /exhibitions/{exhibitionId} {
      allow read: if true;
      
      // 允許登入者更新；未登入者僅能更新計數欄位
      allow update: if request.auth != null
        || (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['exhibit_liked', 'exhibit_viewed'])
          && (
            (!('exhibit_liked' in request.resource.data) || request.resource.data.exhibit_liked is int)
            && (!('exhibit_viewed' in request.resource.data) || request.resource.data.exhibit_viewed is int)
          )
        );
        
      // 限制僅登入者或管理者可以創建/刪除
      allow create: if request.auth != null;
      allow delete: if isAllowedAdmin(); 

      // --- 新增：Analytics 流量統計子集合規則 ---
      match /analytics/{docId} {
        allow read: if true;
        // 允許在符合欄位限制的情況下創建或更新每日/每月/小時統計
        // 支援更多統計欄位：devices, browsers, resolutions, totalSessionSeconds, sessionCount, features
        allow create, update: if (
          request.resource.data.keys().hasOnly(['count', 'date', 'type', 'hour', 'devices', 'browsers', 'resolutions', 'totalSessionSeconds', 'sessionCount', 'features'])
          || request.resource.data.keys().hasAny(['count','hour','devices','browsers','resolutions','totalSessionSeconds','sessionCount','features'])
        );
      }
    }

    // 其他集合保持不變
    match /artists/{artistId} {
      allow write: if request.auth != null;
    }

    match /zones/{zoneId} {
      allow write: if request.auth != null;
    }
    
    match /users/{userId} {
      allow write: if request.auth != null;
    }
    
    match /teams/{teamId} {
      allow write: if request.auth != null;
    }
  }
}

    match /artists/{artistId} {
      allow write: if request.auth != null;
    }

    match /zones/{zoneId} {
      allow write: if request.auth != null;
    }

    // Presence tracking: allow guests to write minimal heartbeat docs
    match /presence/{viewerId} {
      // Public read of presence counts; not sensitive
      allow read: if true;
      allow list: if true;

      // Allow anyone to create/update only the allowed fields and types
      allow create, update: if (
        request.resource.data.keys().hasOnly(['uid','zoneId','lastSeenMs']) &&
        request.resource.data.uid is string &&
        request.resource.data.zoneId is string &&
        request.resource.data.lastSeenMs is int
      );

      // Deny delete to keep accounting simple
      allow delete: if false;
    }

    // Exhibit presence tracking: count viewers per exhibition
    match /exhibit_presence/{viewerId} {
      allow read: if true;
      allow list: if true;

      allow create, update: if (
        request.resource.data.keys().hasOnly(['viewerId','exhibitId','lastSeenMs']) &&
        request.resource.data.viewerId is string &&
        request.resource.data.exhibitId is string &&
        request.resource.data.lastSeenMs is int
      );

      allow delete: if false;
    }
  }
}
